/* 
 *  DSP.js - a comprehensive digital signal processing  library for javascript
 * 
 *  Created by Corban Brook <corbanbrook@gmail.com> on 2010-01-01.
 *  Copyright 2010 Corban Brook. All rights reserved.
 *
 */
////////////////////////////////////////////////////////////////////////////////
//                                  CONSTANTS                                 //
////////////////////////////////////////////////////////////////////////////////
/**
 * DSP is an object which contains general purpose utility functions and constants
 */
function setupTypedArray(a,b){typeof this[a]!="function"&&typeof this[a]!="object"&&(typeof this[b]=="function"&&typeof this[b]!="object"?this[a]=this[b]:this[a]=function(a){if(a instanceof Array)return a;if(typeof a=="number")return new Array(a)})}function FourierTransform(a,b){this.bufferSize=a,this.sampleRate=b,this.bandwidth=2/a*b/2,this.spectrum=new Float32Array(a/2),this.real=new Float32Array(a),this.imag=new Float32Array(a),this.peakBand=0,this.peak=0,this.getBandFrequency=function(a){return this.bandwidth*a+this.bandwidth/2},this.calculateSpectrum=function(){var b=this.spectrum,c=this.real,d=this.imag,e=2/this.bufferSize,f=Math.sqrt,g,h,i;for(var j=0,k=a/2;j<k;j++)g=c[j],h=d[j],i=e*f(g*g+h*h),i>this.peak&&(this.peakBand=j,this.peak=i),b[j]=i}}function DFT(a,b){FourierTransform.call(this,a,b);var c=a/2*a,d=2*Math.PI;this.sinTable=new Float32Array(c),this.cosTable=new Float32Array(c);for(var e=0;e<c;e++)this.sinTable[e]=Math.sin(e*d/a),this.cosTable[e]=Math.cos(e*d/a)}function FFT(a,b){FourierTransform.call(this,a,b),this.reverseTable=new Uint32Array(a);var c=1,d=a>>1,e;while(c<a){for(e=0;e<c;e++)this.reverseTable[e+c]=this.reverseTable[e]+d;c<<=1,d>>=1}this.sinTable=new Float32Array(a),this.cosTable=new Float32Array(a);for(e=0;e<a;e++)this.sinTable[e]=Math.sin(-Math.PI/e),this.cosTable[e]=Math.cos(-Math.PI/e)}function RFFT(a,b){FourierTransform.call(this,a,b),this.trans=new Float32Array(a),this.reverseTable=new Uint32Array(a),this.reverseBinPermute=function(a,b){var c=this.bufferSize,d=c>>>1,e=c-1,f=1,g=0,h;a[0]=b[0];do{g+=d,a[f]=b[g],a[g]=b[f],f++,h=d<<1;while(h>>=1,!((g^=h)&h));g>=f&&(a[f]=b[g],a[g]=b[f],a[e-f]=b[e-g],a[e-g]=b[e-f]),f++}while(f<d);a[e]=b[e]},this.generateReverseTable=function(){var a=this.bufferSize,b=a>>>1,c=a-1,d=1,e=0,f;this.reverseTable[0]=0;do{e+=b,this.reverseTable[d]=e,this.reverseTable[e]=d,d++,f=b<<1;while(f>>=1,!((e^=f)&f));e>=d&&(this.reverseTable[d]=e,this.reverseTable[e]=d,this.reverseTable[c-d]=c-e,this.reverseTable[c-e]=c-d),d++}while(d<b);this.reverseTable[c]=c},this.generateReverseTable()}function Sampler(a,b,c,d,e,f,g,h){this.file=a,this.bufferSize=b,this.sampleRate=c,this.playStart=d||0,this.playEnd=e||1,this.loopStart=f||0,this.loopEnd=g||1,this.loopMode=h||DSP.OFF,this.loaded=!1,this.samples=[],this.signal=new Float32Array(b),this.frameCount=0,this.envelope=null,this.amplitude=1,this.rootFrequency=110,this.frequency=550,this.step=this.frequency/this.rootFrequency,this.duration=0,this.samplesProcessed=0,this.playhead=0;var i=document.createElement("AUDIO"),j=this;this.loadSamples=function(a){var b=DSP.getChannel(DSP.MIX,a.frameBuffer);for(var c=0;c<b.length;c++)j.samples.push(b[c])},this.loadComplete=function(){j.samples=new Float32Array(j.samples),j.loaded=!0},this.loadMetaData=function(){j.duration=i.duration},i.addEventListener("MozAudioAvailable",this.loadSamples,!1),i.addEventListener("loadedmetadata",this.loadMetaData,!1),i.addEventListener("ended",this.loadComplete,!1),i.muted=!0,i.src=a,i.play()}function Oscillator(a,b,c,d,e){this.frequency=b,this.amplitude=c,this.bufferSize=d,this.sampleRate=e,this.frameCount=0,this.waveTableLength=2048,this.cyclesPerSample=b/e,this.signal=new Float32Array(d),this.envelope=null;switch(parseInt(a,10)){case DSP.TRIANGLE:this.func=Oscillator.Triangle;break;case DSP.SAW:this.func=Oscillator.Saw;break;case DSP.SQUARE:this.func=Oscillator.Square;break;default:case DSP.SINE:this.func=Oscillator.Sine}this.generateWaveTable=function(){Oscillator.waveTable[this.func]=new Float32Array(2048);var a=this.waveTableLength/this.sampleRate,b=1/a;for(var c=0;c<this.waveTableLength;c++)Oscillator.waveTable[this.func][c]=this.func(c*b/this.sampleRate)},typeof Oscillator.waveTable=="undefined"&&(Oscillator.waveTable={}),typeof Oscillator.waveTable[this.func]=="undefined"&&this.generateWaveTable(),this.waveTable=Oscillator.waveTable[this.func]}function ADSR(a,b,c,d,e,f){this.sampleRate=f,this.attackLength=a,this.decayLength=b,this.sustainLevel=c,this.sustainLength=d,this.releaseLength=e,this.sampleRate=f,this.attackSamples=a*f,this.decaySamples=b*f,this.sustainSamples=d*f,this.releaseSamples=e*f,this.update=function(){this.attack=this.attackSamples,this.decay=this.attack+this.decaySamples,this.sustain=this.decay+this.sustainSamples,this.release=this.sustain+this.releaseSamples},this.update(),this.samplesProcessed=0}function IIRFilter(a,b,c,d){this.sampleRate=d;switch(a){case DSP.LOWPASS:case DSP.LP12:this.func=new IIRFilter.LP12(b,c,d)}}function IIRFilter2(a,b,c,d){this.type=a,this.cutoff=b,this.resonance=c,this.sampleRate=d,this.f=Float32Array(4),this.f[0]=0,this.f[1]=0,this.f[2]=0,this.f[3]=0,this.calcCoeff=function(a,b){this.freq=2*Math.sin(Math.PI*Math.min(.25,a/(this.sampleRate*2))),this.damp=Math.min(2*(1-Math.pow(b,.25)),Math.min(2,2/this.freq-this.freq*.5))},this.calcCoeff(b,c)}function WindowFunction(a,b){this.alpha=b;switch(a){case DSP.BARTLETT:this.func=WindowFunction.Bartlett;break;case DSP.BARTLETTHANN:this.func=WindowFunction.BartlettHann;break;case DSP.BLACKMAN:this.func=WindowFunction.Blackman,this.alpha=this.alpha||.16;break;case DSP.COSINE:this.func=WindowFunction.Cosine;break;case DSP.GAUSS:this.func=WindowFunction.Gauss,this.alpha=this.alpha||.25;break;case DSP.HAMMING:this.func=WindowFunction.Hamming;break;case DSP.HANN:this.func=WindowFunction.Hann;break;case DSP.LANCZOS:this.func=WindowFunction.Lanczoz;break;case DSP.RECTANGULAR:this.func=WindowFunction.Rectangular;break;case DSP.TRIANGULAR:this.func=WindowFunction.Triangular}}function sinh(a){return(Math.exp(a)-Math.exp(-a))/2}function Biquad(a,b){this.Fs=b,this.type=a,this.parameterType=DSP.Q,this.x_1_l=0,this.x_2_l=0,this.y_1_l=0,this.y_2_l=0,this.x_1_r=0,this.x_2_r=0,this.y_1_r=0,this.y_2_r=0,this.b0=1,this.a0=1,this.b1=0,this.a1=0,this.b2=0,this.a2=0,this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0,this.f0=3e3,this.dBgain=12,this.Q=1,this.BW=-3,this.S=1,this.coefficients=function(){var a=[this.b0,this.b1,this.b2],b=[this.a0,this.a1,this.a2];return{b:a,a:b}},this.setFilterType=function(a){this.type=a,this.recalculateCoefficients()},this.setSampleRate=function(a){this.Fs=a,this.recalculateCoefficients()},this.setQ=function(a){this.parameterType=DSP.Q,this.Q=Math.max(Math.min(a,115),.001),this.recalculateCoefficients()},this.setBW=function(a){this.parameterType=DSP.BW,this.BW=a,this.recalculateCoefficients()},this.setS=function(a){this.parameterType=DSP.S,this.S=Math.max(Math.min(a,5),1e-4),this.recalculateCoefficients()},this.setF0=function(a){this.f0=a,this.recalculateCoefficients()},this.setDbGain=function(a){this.dBgain=a,this.recalculateCoefficients()},this.recalculateCoefficients=function(){var b;a===DSP.PEAKING_EQ||a===DSP.LOW_SHELF||a===DSP.HIGH_SHELF?b=Math.pow(10,this.dBgain/40):b=Math.sqrt(Math.pow(10,this.dBgain/20));var c=DSP.TWO_PI*this.f0/this.Fs,d=Math.cos(c),e=Math.sin(c),f=0;switch(this.parameterType){case DSP.Q:f=e/(2*this.Q);break;case DSP.BW:f=e*sinh(Math.LN2/2*this.BW*c/e);break;case DSP.S:f=e/2*Math.sqrt((b+1/b)*(1/this.S-1)+2)}var g;switch(this.type){case DSP.LPF:this.b0=(1-d)/2,this.b1=1-d,this.b2=(1-d)/2,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.HPF:this.b0=(1+d)/2,this.b1=-(1+d),this.b2=(1+d)/2,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.BPF_CONSTANT_SKIRT:this.b0=e/2,this.b1=0,this.b2=-e/2,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.BPF_CONSTANT_PEAK:this.b0=f,this.b1=0,this.b2=-f,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.NOTCH:this.b0=1,this.b1=-2*d,this.b2=1,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.APF:this.b0=1-f,this.b1=-2*d,this.b2=1+f,this.a0=1+f,this.a1=-2*d,this.a2=1-f;break;case DSP.PEAKING_EQ:this.b0=1+f*b,this.b1=-2*d,this.b2=1-f*b,this.a0=1+f/b,this.a1=-2*d,this.a2=1-f/b;break;case DSP.LOW_SHELF:g=e*Math.sqrt((b^3)*(1/this.S-1)+2*b),this.b0=b*(b+1-(b-1)*d+g),this.b1=2*b*(b-1-(b+1)*d),this.b2=b*(b+1-(b-1)*d-g),this.a0=b+1+(b-1)*d+g,this.a1=-2*(b-1+(b+1)*d),this.a2=b+1+(b-1)*d-g;break;case DSP.HIGH_SHELF:g=e*Math.sqrt((b^3)*(1/this.S-1)+2*b),this.b0=b*(b+1+(b-1)*d+g),this.b1=-2*b*(b-1+(b+1)*d),this.b2=b*(b+1+(b-1)*d-g),this.a0=b+1-(b-1)*d+g,this.a1=2*(b-1-(b+1)*d),this.a2=b+1-(b-1)*d-g}this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0},this.process=function(a){var b=a.length,c=new Float32Array(b);for(var d=0;d<a.length;d++)c[d]=this.b0a0*a[d]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=c[d],this.x_2_l=this.x_1_l,this.x_1_l=a[d];return c},this.processStereo=function(a){var b=a.length,c=new Float32Array(b);for(var d=0;d<b/2;d++)c[2*d]=this.b0a0*a[2*d]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=c[2*d],this.x_2_l=this.x_1_l,this.x_1_l=a[2*d],c[2*d+1]=this.b0a0*a[2*d+1]+this.b1a0*this.x_1_r+this.b2a0*this.x_2_r-this.a1a0*this.y_1_r-this.a2a0*this.y_2_r,this.y_2_r=this.y_1_r,this.y_1_r=c[2*d+1],this.x_2_r=this.x_1_r,this.x_1_r=a[2*d+1];return c}}function GraphicalEq(a){this.FS=a,this.minFreq=40,this.maxFreq=16e3,this.bandsPerOctave=1,this.filters=[],this.freqzs=[],this.calculateFreqzs=!0,this.recalculateFilters=function(){var a=Math.round(Math.log(this.maxFreq/this.minFreq)*this.bandsPerOctave/Math.LN2);this.filters=[];for(var b=0;b<a;b++){var c=this.minFreq*Math.pow(2,b/this.bandsPerOctave),d=new Biquad(DSP.PEAKING_EQ,this.FS);d.setDbGain(0),d.setBW(1/this.bandsPerOctave),d.setF0(c),this.filters[b]=d,this.recalculateFreqz(b)}},this.setMinimumFrequency=function(a){this.minFreq=a,this.recalculateFilters()},this.setMaximumFrequency=function(a){this.maxFreq=a,this.recalculateFilters()},this.setBandsPerOctave=function(a){this.bandsPerOctave=a,this.recalculateFilters()},this.setBandGain=function(a,b){if(a<0||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds.";if(!b)throw"A gain must be passed.";this.filters[a].setDbGain(b),this.recalculateFreqz(a)},this.recalculateFreqz=function(a){if(!this.calculateFreqzs)return;if(a<0||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds. "+a+" is out of ["+0+", "+this.filters.length-1+"]";if(!this.w){this.w=Float32Array(400);for(var b=0;b<this.w.length;b++)this.w[b]=Math.PI/this.w.length*b}var c=[this.filters[a].b0,this.filters[a].b1,this.filters[a].b2],d=[this.filters[a].a0,this.filters[a].a1,this.filters[a].a2];this.freqzs[a]=DSP.mag2db(DSP.freqz(c,d,this.w))},this.process=function(a){var b=a;for(var c=0;c<this.filters.length;c++)b=this.filters[c].process(b);return b},this.processStereo=function(a){var b=a;for(var c=0;c<this.filters.length;c++)b=this.filters[c].processStereo(b);return b}}function MultiDelay(a,b,c,d){this.delayBufferSamples=new Float32Array(a),this.delayInputPointer=b,this.delayOutputPointer=0,this.delayInSamples=b,this.masterVolume=c,this.delayVolume=d}function SingleDelay(a,b,c){this.delayBufferSamples=new Float32Array(a),this.delayInputPointer=b,this.delayOutputPointer=0,this.delayInSamples=b,this.delayVolume=c}function Reverb(a,b,c,d,e,f){this.delayInSamples=b,this.masterVolume=c,this.mixVolume=d,this.delayVolume=e,this.dampFrequency=f,this.NR_OF_MULTIDELAYS=6,this.NR_OF_SINGLEDELAYS=6,this.LOWPASSL=new IIRFilter2(DSP.LOWPASS,f,0,44100),this.LOWPASSR=new IIRFilter2(DSP.LOWPASS,f,0,44100),this.singleDelays=[];var g,h;for(g=0;g<this.NR_OF_SINGLEDELAYS;g++)h=1+g/7,this.singleDelays[g]=new SingleDelay(a,Math.round(this.delayInSamples*h),this.delayVolume);this.multiDelays=[];for(g=0;g<this.NR_OF_MULTIDELAYS;g++)h=1+g/10,this.multiDelays[g]=new MultiDelay(a,Math.round(this.delayInSamples*h),this.masterVolume,this.delayVolume)}var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};setupTypedArray("Float32Array","WebGLFloatArray"),setupTypedArray("Int32Array","WebGLIntArray"),setupTypedArray("Uint16Array","WebGLUnsignedShortArray"),setupTypedArray("Uint8Array","WebGLUnsignedByteArray"),DSP.invert=function(a){for(var b=0,c=a.length;b<c;b++)a[b]*=-1;return a},DSP.interleave=function(a,b){if(a.length!==b.length)throw"Can not interleave. Channel lengths differ.";var c=new Float32Array(a.length*2);for(var d=0,e=a.length;d<e;d++)c[2*d]=a[d],c[2*d+1]=b[d];return c},DSP.deinterleave=function(){var a,b,c,d=[];return d[DSP.MIX]=function(a){for(var b=0,d=a.length/2;b<d;b++)c[b]=(a[2*b]+a[2*b+1])/2;return c},d[DSP.LEFT]=function(b){for(var c=0,d=b.length/2;c<d;c++)a[c]=b[2*c];return a},d[DSP.RIGHT]=function(a){for(var c=0,d=a.length/2;c<d;c++)b[c]=a[2*c+1];return b},function(e,f){return a=a||new Float32Array(f.length/2),b=b||new Float32Array(f.length/2),c=c||new Float32Array(f.length/2),f.length/2!==a.length&&(a=new Float32Array(f.length/2),b=new Float32Array(f.length/2),c=new Float32Array(f.length/2)),d[e](f)}}(),DSP.getChannel=DSP.deinterleave,DSP.mixSampleBuffers=function(a,b,c,d){var e=new Float32Array(a);for(var f=0;f<a.length;f++)e[f]+=(c?-b[f]:b[f])/d;return e},DSP.LPF=0,DSP.HPF=1,DSP.BPF_CONSTANT_SKIRT=2,DSP.BPF_CONSTANT_PEAK=3,DSP.NOTCH=4,DSP.APF=5,DSP.PEAKING_EQ=6,DSP.LOW_SHELF=7,DSP.HIGH_SHELF=8,DSP.Q=1,DSP.BW=2,DSP.S=3,DSP.RMS=function(a){var b=0;for(var c=0,d=a.length;c<d;c++)b+=a[c]*a[c];return Math.sqrt(b/d)},DSP.Peak=function(a){var b=0;for(var c=0,d=a.length;c<d;c++)b=Math.abs(a[c])>b?Math.abs(a[c]):b;return b},DFT.prototype.forward=function(a){var b=this.real,c=this.imag,d,e;for(var f=0;f<this.bufferSize/2;f++){d=0,e=0;for(var g=0;g<a.length;g++)d+=this.cosTable[f*g]*a[g],e+=this.sinTable[f*g]*a[g];b[f]=d,c[f]=e}return this.calculateSpectrum()},FFT.prototype.forward=function(a){var b=this.bufferSize,c=this.cosTable,d=this.sinTable,e=this.reverseTable,f=this.real,g=this.imag,h=this.spectrum,i=Math.floor(Math.log(b)/Math.LN2);if(Math.pow(2,i)!==b)throw"Invalid buffer size, must be a power of 2.";if(b!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+b+" Buffer Size: "+a.length;var j=1,k,l,m,n,o,p,q,r,s;for(s=0;s<b;s++)f[s]=a[e[s]],g[s]=0;while(j<b){k=c[j],l=d[j],m=1,n=0;for(var t=0;t<j;t++){s=t;while(s<b)o=s+j,p=m*f[o]-n*g[o],q=m*g[o]+n*f[o],f[o]=f[s]-p,g[o]=g[s]-q,f[s]+=p,g[s]+=q,s+=j<<1;r=m,m=r*k-n*l,n=r*l+n*k}j<<=1}return this.calculateSpectrum()},FFT.prototype.inverse=function(a,b){var c=this.bufferSize,d=this.cosTable,e=this.sinTable,f=this.reverseTable,g=this.spectrum;a=a||this.real,b=b||this.imag;var h=1,i,j,k,l,m,n,o,p,q;for(q=0;q<c;q++)b[q]*=-1;var r=new Float32Array(c),s=new Float32Array(c);for(q=0;q<a.length;q++)r[q]=a[f[q]],s[q]=b[f[q]];a=r,b=s;while(h<c){i=d[h],j=e[h],k=1,l=0;for(var t=0;t<h;t++){q=t;while(q<c)m=q+h,n=k*a[m]-l*b[m],o=k*b[m]+l*a[m],a[m]=a[q]-n,b[m]=b[q]-o,a[q]+=n,b[q]+=o,q+=h<<1;p=k,k=p*i-l*j,l=p*j+l*i}h<<=1}var u=new Float32Array(c);for(q=0;q<c;q++)u[q]=a[q]/c;return u},RFFT.prototype.forward=function(a){var b=this.bufferSize,c=this.spectrum,d=this.trans,e=2*Math.PI,f=Math.sqrt,g=b>>>1,h=2/b,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;this.reverseBinPermute(d,a);for(var I=0,J=4;I<b;J*=4){for(var K=I;K<b;K+=J)y=d[K]-d[K+1],d[K]+=d[K+1],d[K+1]=y;I=2*(J-1)}i=2,l=b>>>1;while(l>>>=1){I=0,i<<=1,J=i<<1,j=i>>>2,k=i>>>3;do{if(j!==1)for(K=I;K<b;K+=J)q=K,r=q+j,s=r+j,t=s+j,m=d[s]+d[t],d[t]-=d[s],d[s]=d[q]-m,d[q]+=m,q+=k,r+=k,s+=k,t+=k,m=d[s]+d[t],n=d[s]-d[t],m=-m*Math.SQRT1_2,n*=Math.SQRT1_2,y=d[r],d[t]=m+y,d[s]=m-y,d[r]=d[q]-n,d[q]+=n;else for(K=I;K<b;K+=J)q=K,r=q+j,s=r+j,t=s+j,m=d[s]+d[t],d[t]-=d[s],d[s]=d[q]-m,d[q]+=m;I=(J<<1)-i,J<<=2}while(I<b);D=e/i;for(var L=1;L<k;L++){E=L*D,A=Math.sin(E),z=Math.cos(E),B=4*z*(z*z-.75),C=4*A*(.75-A*A),I=0,J=i<<1;do{for(K=I;K<b;K+=J)q=K+L,r=q+j,s=r+j,t=s+j,u=K+j-L,v=u+j,w=v+j,x=w+j,n=d[w]*z-d[s]*A,m=d[w]*A+d[s]*z,p=d[x]*B-d[t]*C,o=d[x]*C+d[t]*B,y=n-p,n+=p,p=y,d[x]=n+d[v],d[s]=n-d[v],y=o-m,m+=o,o=y,d[t]=o+d[r],d[w]=o-d[r],d[v]=d[q]-m,d[q]+=m,d[r]=p+d[u],d[u]-=p;I=(J<<1)-i,J<<=2}while(I<b)}}while(--g)F=d[g],G=d[b-g-1],H=h*f(F*F+G*G),H>this.peak&&(this.peakBand=g,this.peak=H),c[g]=H;return c[0]=h*d[0],c},Sampler.prototype.applyEnvelope=function(){return this.envelope.process(this.signal),this.signal},Sampler.prototype.generate=function(){var a=this.frameCount*this.bufferSize,b=this.playEnd*this.samples.length-this.playStart*this.samples.length,c=this.playStart*this.samples.length,d=this.playEnd*this.samples.length,e;for(var f=0;f<this.bufferSize;f++){switch(this.loopMode){case DSP.OFF:this.playhead=Math.round(this.samplesProcessed*this.step+c),this.playhead<this.playEnd*this.samples.length?this.signal[f]=this.samples[this.playhead]*this.amplitude:this.signal[f]=0;break;case DSP.FW:this.playhead=Math.round(this.samplesProcessed*this.step%b+c),this.playhead<this.playEnd*this.samples.length&&(this.signal[f]=this.samples[this.playhead]*this.amplitude);break;case DSP.BW:this.playhead=d-Math.round(this.samplesProcessed*this.step%b),this.playhead<this.playEnd*this.samples.length&&(this.signal[f]=this.samples[this.playhead]*this.amplitude);break;case DSP.FWBW:Math.floor(this.samplesProcessed*this.step/b)%2===0?this.playhead=Math.round(this.samplesProcessed*this.step%b+c):this.playhead=d-Math.round(this.samplesProcessed*this.step%b),this.playhead<this.playEnd*this.samples.length&&(this.signal[f]=this.samples[this.playhead]*this.amplitude)}this.samplesProcessed++}return this.frameCount++,this.signal},Sampler.prototype.setFreq=function(a){var b=this.samplesProcessed*this.step;this.frequency=a,this.step=this.frequency/this.rootFrequency,this.samplesProcessed=Math.round(b/this.step)},Sampler.prototype.reset=function(){this.samplesProcessed=0,this.playhead=0},Oscillator.prototype.setAmp=function(a){if(!(a>=0&&a<=1))throw"Amplitude out of range (0..1).";this.amplitude=a},Oscillator.prototype.setFreq=function(a){this.frequency=a,this.cyclesPerSample=a/this.sampleRate},Oscillator.prototype.add=function(a){for(var b=0;b<this.bufferSize;b++)this.signal[b]+=a.signal[b];return this.signal},Oscillator.prototype.addSignal=function(a){for(var b=0;b<a.length;b++){if(b>=this.bufferSize)break;this.signal[b]+=a[b]}return this.signal},Oscillator.prototype.addEnvelope=function(a){this.envelope=a},Oscillator.prototype.applyEnvelope=function(){this.envelope.process(this.signal)},Oscillator.prototype.valueAt=function(a){return this.waveTable[a%this.waveTableLength]},Oscillator.prototype.generate=function(){var a=this.frameCount*this.bufferSize,b=this.waveTableLength*this.frequency/this.sampleRate,c;for(var d=0;d<this.bufferSize;d++)c=Math.round((a+d)*b),this.signal[d]=this.waveTable[c%this.waveTableLength]*this.amplitude;return this.frameCount++,this.signal},Oscillator.Sine=function(a){return Math.sin(DSP.TWO_PI*a)},Oscillator.Square=function(a){return a<.5?1:-1},Oscillator.Saw=function(a){return 2*(a-Math.round(a))},Oscillator.Triangle=function(a){return 1-4*Math.abs(Math.round(a)-a)},Oscillator.Pulse=function(a){},ADSR.prototype.noteOn=function(){this.samplesProcessed=0,this.sustainSamples=this.sustainLength*this.sampleRate,this.update()},ADSR.prototype.noteOff=function(){this.sustainSamples=this.samplesProcessed-this.decaySamples,this.update()},ADSR.prototype.processSample=function(a){var b=0;return this.samplesProcessed<=this.attack?b=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?b=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?b=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(b=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))),a*b},ADSR.prototype.value=function(){var a=0;return this.samplesProcessed<=this.attack?a=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?a=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?a=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(a=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))),a},ADSR.prototype.process=function(a){for(var b=0;b<a.length;b++)a[b]*=this.value(),this.samplesProcessed++;return a},ADSR.prototype.isActive=function(){return this.samplesProcessed>this.release||this.samplesProcessed===-1?!1:!0},ADSR.prototype.disable=function(){this.samplesProcessed=-1},IIRFilter.prototype.__defineGetter__("cutoff",function(){return this.func.cutoff}),IIRFilter.prototype.__defineGetter__("resonance",function(){return this.func.resonance}),IIRFilter.prototype.set=function(a,b){this.func.calcCoeff(a,b)},IIRFilter.prototype.process=function(a){this.func.process(a)},IIRFilter.prototype.addEnvelope=function(a){if(!(a instanceof ADSR))throw"Not an envelope.";this.func.addEnvelope(a)},IIRFilter.LP12=function(a,b,c){this.sampleRate=c,this.vibraPos=0,this.vibraSpeed=0,this.envelope=!1,this.calcCoeff=function(a,b){this.w=2*Math.PI*a/this.sampleRate,this.q=1-this.w/(2*(b+.5/(1+this.w))+this.w-2),this.r=this.q*this.q,this.c=this.r+1-2*Math.cos(this.w)*this.q,this.cutoff=a,this.resonance=b},this.calcCoeff(a,b),this.process=function(a){for(var b=0;b<a.length;b++)this.vibraSpeed+=(a[b]-this.vibraPos)*this.c,this.vibraPos+=this.vibraSpeed,this.vibraSpeed*=this.r,this.envelope?(a[b]=a[b]*(1-this.envelope.value())+this.vibraPos*this.envelope.value(),this.envelope.samplesProcessed++):a[b]=this.vibraPos}},IIRFilter.LP12.prototype.addEnvelope=function(a){this.envelope=a},IIRFilter2.prototype.process=function(a){var b,c,d=this.f;for(var e=0;e<a.length;e++)b=a[e],d[3]=b-this.damp*d[2],d[0]=d[0]+this.freq*d[2],d[1]=d[3]-d[0],d[2]=this.freq*d[1]+d[2],c=.5*d[this.type],d[3]=b-this.damp*d[2],d[0]=d[0]+this.freq*d[2],d[1]=d[3]-d[0],d[2]=this.freq*d[1]+d[2],c+=.5*d[this.type],this.envelope?(a[e]=a[e]*(1-this.envelope.value())+c*this.envelope.value(),this.envelope.samplesProcessed++):a[e]=c},IIRFilter2.prototype.addEnvelope=function(a){if(!(a instanceof ADSR))throw"This is not an envelope.";this.envelope=a},IIRFilter2.prototype.set=function(a,b){this.calcCoeff(a,b)},WindowFunction.prototype.process=function(a){var b=a.length;for(var c=0;c<b;c++)a[c]*=this.func(b,c,this.alpha);return a},WindowFunction.Bartlett=function(a,b){return 2/(a-1)*((a-1)/2-Math.abs(b-(a-1)/2))},WindowFunction.BartlettHann=function(a,b){return.62-.48*Math.abs(b/(a-1)-.5)-.38*Math.cos(DSP.TWO_PI*b/(a-1))},WindowFunction.Blackman=function(a,b,c){var d=(1-c)/2,e=.5,f=c/2;return d-e*Math.cos(DSP.TWO_PI*b/(a-1))+f*Math.cos(4*Math.PI*b/(a-1))},WindowFunction.Cosine=function(a,b){return Math.cos(Math.PI*b/(a-1)-Math.PI/2)},WindowFunction.Gauss=function(a,b,c){return Math.pow(Math.E,-0.5*Math.pow((b-(a-1)/2)/(c*(a-1)/2),2))},WindowFunction.Hamming=function(a,b){return.54-.46*Math.cos(DSP.TWO_PI*b/(a-1))},WindowFunction.Hann=function(a,b){return.5*(1-Math.cos(DSP.TWO_PI*b/(a-1)))},WindowFunction.Lanczos=function(a,b){var c=2*b/(a-1)-1;return Math.sin(Math.PI*c)/(Math.PI*c)},WindowFunction.Rectangular=function(a,b){return 1},WindowFunction.Triangular=function(a,b){return 2/a*(a/2-Math.abs(b-(a-1)/2))},DSP.mag2db=function(a){var b=-120,c=Math.pow(10,b/20),d=Math.log,e=Math.max,f=Float32Array(a.length);for(var g=0;g<a.length;g++)f[g]=20*d(e(a[g],c));return f},DSP.freqz=function(a,b,c){var d,e;if(!c){c=Float32Array(200);for(d=0;d<c.length;d++)c[d]=DSP.TWO_PI/c.length*d-Math.PI}var f=Float32Array(c.length),g=Math.sqrt,h=Math.cos,i=Math.sin;for(d=0;d<c.length;d++){var j={real:0,imag:0};for(e=0;e<a.length;e++)j.real+=a[e]*h(-e*c[d]),j.imag+=a[e]*i(-e*c[d]);var k={real:0,imag:0};for(e=0;e<b.length;e++)k.real+=b[e]*h(-e*c[d]),k.imag+=b[e]*i(-e*c[d]);f[d]=g(j.real*j.real+j.imag*j.imag)/g(k.real*k.real+k.imag*k.imag)}return f},MultiDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a,this.delayInputPointer=this.delayOutputPointer+a,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},MultiDelay.prototype.setMasterVolume=function(a){this.masterVolume=a},MultiDelay.prototype.setDelayVolume=function(a){this.delayVolume=a},MultiDelay.prototype.process=function(a){var b=new Float32Array(a.length);for(var c=0;c<a.length;c++){var d=this.delayBufferSamples[this.delayOutputPointer]===null?0:this.delayBufferSamples[this.delayOutputPointer],e=d*this.delayVolume+a[c];this.delayBufferSamples[this.delayInputPointer]=e,b[c]=e*this.masterVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0)}return b},SingleDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a,this.delayInputPointer=this.delayOutputPointer+a,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},SingleDelay.prototype.setDelayVolume=function(a){this.delayVolume=a},SingleDelay.prototype.process=function(a){var b=new Float32Array(a.length);for(var c=0;c<a.length;c++){this.delayBufferSamples[this.delayInputPointer]=a[c];var d=this.delayBufferSamples[this.delayOutputPointer];b[c]=d*this.delayVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0)}return b},Reverb.prototype.setDelayInSamples=function(a){this.delayInSamples=a;var b,c;for(b=0;b<this.NR_OF_SINGLEDELAYS;b++)c=1+b/7,this.singleDelays[b].setDelayInSamples(Math.round(this.delayInSamples*c));for(b=0;b<this.NR_OF_MULTIDELAYS;b++)c=1+b/10,this.multiDelays[b].setDelayInSamples(Math.round(this.delayInSamples*c))},Reverb.prototype.setMasterVolume=function(a){this.masterVolume=a},Reverb.prototype.setMixVolume=function(a){this.mixVolume=a},Reverb.prototype.setDelayVolume=function(a){this.delayVolume=a;var b;for(b=0;b<this.NR_OF_SINGLEDELAYS;b++)this.singleDelays[b].setDelayVolume(this.delayVolume);for(b=0;b<this.NR_OF_MULTIDELAYS;b++)this.multiDelays[b].setDelayVolume(this.delayVolume)},Reverb.prototype.setDampFrequency=function(a){this.dampFrequency=a,this.LOWPASSL.set(a,0),this.LOWPASSR.set(a,0)},Reverb.prototype.process=function(a){var b=new Float32Array(a.length),c=DSP.deinterleave(a);this.LOWPASSL.process(c[DSP.LEFT]),this.LOWPASSR.process(c[DSP.RIGHT]);var d=DSP.interleave(c[DSP.LEFT],c[DSP.RIGHT]),e;for(e=0;e<this.NR_OF_MULTIDELAYS;e++)b=DSP.mixSampleBuffers(b,this.multiDelays[e].process(d),2%e===0,this.NR_OF_MULTIDELAYS);var f=new Float32Array(b.length);for(e=0;e<this.NR_OF_SINGLEDELAYS;e++)f=DSP.mixSampleBuffers(f,this.singleDelays[e].process(b),2%e===0,1);for(e=0;e<f.length;e++)f[e]*=this.mixVolume;b=DSP.mixSampleBuffers(f,a,0,1);for(e=0;e<b.length;e++)b[e]*=this.masterVolume;return b};